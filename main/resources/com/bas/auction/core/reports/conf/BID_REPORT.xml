<?xml version="1.0" encoding="UTF-8"?>
<sql>
	<sqlStatement name="BID_HEADER">
			<![CDATA[
Select T.neg_type,
       T.Supplier_Name
      ,T.Supplier_Address
      ,T.Rnn
      ,T.Identification_Number
      ,T.Email
      ,T.Phone_Number
      ,T.Currency
      ,T.Currency_Code
      ,T.Rate
      ,To_Char(T.Creation_Date, 'DD.MM.YYYY') Creation_Date
      ,T.Total_Amount
      ,Auction.Number2word(T.Total_Amount, T.Currency_Code ::Text) Total_Amount_Word
      ,T.Bid_Comments
  From (Select n.neg_type,
               S.Name_Ru Supplier_Name
              ,Case
				 When A1.Address_Id Is Not Null Then
				  concat('КАТО:' || A1.Kato || ', ', 'г.' || A1.City || ', ', A1.Address_Line || ', ',
				         'тел. ' || A1.Phone_Number)
				 Else
				  concat('КАТО:' || A2.Kato || ', ', 'г.' || A2.City || ', ', A2.Address_Line,
				         'тел. ' || A2.Phone_Number)
               End Supplier_Address
              ,S.Rnn
              ,S.Identification_Number
              ,Coalesce(A1.Email, A2.Email) Email
              ,Coalesce(A1.Phone_Number, A2.Phone_Number) Phone_Number
              ,C.Name Currency
              ,Bh.Currency_Code
              ,Bh.Sent_Exchange_Rate Rate
              ,Bh.Creation_Date
              ,(Select Sum(Nl.Quantity * Bl.Bid_Price)
                  From Auction.Pd_Bid_Lines Bl
                  Join Auction.Pd_Neg_Lines Nl
                    On Nl.Line_Num = Bl.Line_Num
                 Where Bl.Bid_Id = Bh.Bid_Id
                   And Nl.Neg_Id = Bh.Neg_Id
                   And Bl.Bid_Price Is Not Null) Total_Amount
              ,Bh.Bid_Comments
          From Auction.pd_neg_header n
          JOIN Auction.Pd_Bid_Header Bh
            On n.neg_id = Bh.neg_id
          Join Auction.Suppliers s
            On S.Supplier_Id = Bh.Supplier_Id
          Join Auction.Currencies C
            On C.code = Bh.Currency_Code
          Left Join Auction.Addresses A1
            On A1.Supplier_Id = Bh.Supplier_Id
           And A1.Address_Type = 'PHYSICAL_ADDRESS'
          Left Join Auction.Addresses A2
            On A2.Supplier_Id = Bh.Supplier_Id
           And A2.Address_Type = 'LEGAL'
		  Where Bh.Bid_Id = ?) t]]>
	</sqlStatement>
	<sqlStatement name="BID_LINES">
			<![CDATA[
Select Bl.Line_Num
      ,Nl.Item_Name_Ru
      ,Nl.Item_Short_Desc_Ru
      ,Nl.Shipping_Location
      ,Nl.Shipping_Date
      ,Nl.Quantity
      ,Bl.Bid_Price
      ,Nl.Quantity * Bl.Bid_Price Bid_Amount
  From Auction.Pd_Bid_Header Bh
  Join Auction.Pd_Bid_Lines Bl
    On Bl.Bid_Id = Bh.Bid_Id
  Join Auction.Pd_Neg_Lines Nl
    On Nl.Neg_Id = Bh.Neg_Id
   And Nl.Line_Num = Bl.Line_Num
 Where Bh.Bid_Id = ?
   And Bl.Bid_Price Is Not Null
 Order By Bl.Line_Num]]>
	</sqlStatement>
	<sqlStatement name="DOCUMENTS">
			<![CDATA[
SELECT row_number() over(ORDER BY f.file_name) row_num, f.file_name, l.meaning file_type
  FROM auction.files f
  JOIN auction.file_attributes fa
    ON fa.file_id = f.file_id
  LEFT JOIN auction.file_attributes fa2
    ON fa2.name = 'file_type'
   AND fa2.file_id = fa.file_id
  LEFT JOIN auction.lookup_values l
    ON fa2.value = l.lookup_code
   AND l.lookup_type = 'BID_HDR_DOCS'
   AND l.language = 'RU'
 WHERE fa.value = ?::text
   AND fa.name = 'bid_id']]>
	</sqlStatement>
</sql>